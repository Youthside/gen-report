// src/hooks/useGeminiChat.ts
import { useState } from "react";
import { GoogleGenerativeAI } from "@google/generative-ai";

const MODEL_NAME = "gemini-2.5-pro-exp-03-25";
const API_KEY = import.meta.env.VITE_GEMINI_API_KEY; // Vite için örnek .env

const generationConfig = {
  temperature: 1,
  topP: 0.95,
  topK: 64,
  maxOutputTokens: 65536,
  responseMimeType: "text/plain",
};

export function useGeminiChat(initialPrompt?: string) {
  const [response, setResponse] = useState<string | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState<null | string>(null);

  const sendMessage = async (userMessage: string) => {
    setLoading(true);
    setError(null);
    try {
      const genAI = new GoogleGenerativeAI(API_KEY);
      const model = genAI.getGenerativeModel({ model: MODEL_NAME });

      const chat = model.startChat({
        generationConfig,
        history: [
          {
            role: "user",
            parts: [
              {
                text: '## 📄 `Modelfile.md` – Potansiyel Satın Alıcı Analizcisi\n\n\n# Potansiyel Satın Alıcı Analizcisi - Model Dosyası (Modelfile)\nBu model, bir başvuru sahibinin ödeme yapma potansiyelini değerlendirir. Başvuru formundaki verileri analiz ederek, adayın profili üzerinden dönüşüm ihtimali, satın alma gücü ve ikna stratejileri üretir.\n\n---\n\n## 🎯 Modelin Rolü:\nSen, **finansal değerlendirme ve dijital satış** konularında uzmanlaşmış bir yapay zeka danışmanısın. Görevin, başvuru yapan bir kişinin **ödeme yapma olasılığını**, **eğitim profiline göre satın alma gücünü**, ve **ikna edilebilirlik derecesini** net şekilde analiz etmektir.\n\n---\n\n## 🧠 Değerlendirme Prensipleri:\n- **Veriye dayalı ve objektif** analizler yap.\n- Eksik ya da yetersiz bilgi varsa belirt.\n- Aşırı iyimser veya bağlam dışı yorumlardan kaçın.\n- Kullanıcının eğitim durumu, ders tercihi, şehir, sınıf ve geçmiş ödeme davranışlarına göre karar ver.\n- Satın alma gücü veya motivasyon yoksa bunu net şekilde belirt.\n- Veriye dayalı **ikna stratejileri** üret.\n\n---\n\n## 🧾 Girdi Formatı (input):\nAşağıdaki gibi bir başvuru formu girişi gelecektir:\n\n```yaml\nAd: Rabia Kahya\nEğitim Durumu: Lise Öğrencisi\nÜniversite: -\nSınıf: Hazırlık\nSeçtiği Dersler: Yazılım Teknolojileri ve Yapay Zeka, Satış ve Pazarlama\nŞehir: Ankara\nMail: rabia.kahya@gmail.com\n```\n\n---\n\n## 📤 Yanıt Formatı (output):\nCevabını **sadece** aşağıdaki JSON yapısında ver:\n\n```json\n{\n  "payment_possibility": "Adayın ödeme yapma ihtimali (düşük / orta / yüksek)",\n  "justification": "Bu değerlendirmenin gerekçesi. Net, kısa ve veriye dayalı olmalı.",\n  "buyer_persona": "Bu kişinin hangi satış personası grubuna ait olduğu (örn. öğrenci, erken kariyer, profesyonel, yüksek potansiyelli, düşük dönüşüm adayı)",\n  "conversion_score": 0-100 arası dönüşüm puanı (dijital satış ihtimali),\n  "recommended_strategy": "Bu kişiyi ödeme yapmaya ikna etmek için uygulanabilecek en uygun strateji.",\n  "next_action": "Satış ekibinin atması gereken bir sonraki adım (örn. sms, kampanya maili, özel indirim, ilgisiz bırak)"\n}\n```\n\n---\n\n## ⚠️ UYARI:\nEğer adayın verisi eksik, uyumsuz veya güven vermiyorsa:\n- `"payment_possibility"` alanını `"düşük"` olarak ver\n- `"recommended_strategy"` alanında "Daha fazla bilgi alınmalı" de\n\n---\n\n## 🎓 Personalar İçin Örnek Segmentler:\n- `Lise Öğrencisi` → düşük ödeme ihtimali, giriş paketleri önerilmeli\n- `3.-4. Sınıf Mühendislik Öğrencisi` → yüksek potansiyel, kariyer motivasyonu yüksek\n- `Yurt dışında okuyanlar` → %50-%70 dönüşüm ihtimali, döviz etkisi\n- `Mezun + Dijital Pazarlama Seçmiş` → dönüşüm için sıcak aday\n\n---\n\n## 🔍 Kontrol Listesi:\n- Seçilen dersler → satın alma ilgisini gösterir mi?\n- Eğitim durumu → ödeme gücünü etkiler mi?\n- Şehir → ödeme potansiyelini etkileyebilir mi?\n- Mail tipi (gmail, edu.tr) → kurumsallık göstergesi olabilir mi?\n\n---\n\n## 🔒 Not:\nModel finansal değerlendirme yaparken **yargılayıcı değil**, **analitik ve veri odaklı** olmalıdır. Her aday, satış yolculuğunda bir fırsattır.\n',
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: 'My thinking process to generate the JSON output based on the `Modelfile.md` and the example input goes like this:\n\n1.  **Understand the Goal:** The core task is to analyze a potential buyer\'s application form and output a JSON structure containing an assessment of their payment possibility, a justification, a buyer persona, a conversion score, a recommended strategy, and the next action for the sales team.\n\n2.  **Identify the Key Information in the Input:**\n    *   `Ad: Rabia Kahya` (Not directly used in analysis, but identifies the person)\n    *   `Eğitim Durumu: Lise Öğrencisi` (Crucial for payment possibility and persona)\n    *   `Üniversite: -` (Confirms lise status)\n    *   `Sınıf: Hazırlık` (Reinforces the "Lise Öğrencisi" status, likely refers to high school prep or early high school)\n    *   `Seçtiği Dersler: Yazılım Teknolojileri ve Yapay Zeka, Satış ve Pazarlama` (Indicates interest, but perhaps aspirational given the age/status)\n    *   `Şehir: Ankara` (Major city, but less impactful for a high school student\'s *own* purchasing power)\n    *   `Mail: rabia.kahya@gmail.com` (Standard personal email, no special indicator)\n\n3.  **Consult the `Modelfile.md` Guidelines:**\n    *   **Model\'s Role:** Act as a financial/digital sales expert. Assess payment possibility, purchasing power (based on education), and persuasiveness.\n    *   **Evaluation Principles:** Be data-driven, objective. Mention missing info (not applicable here). Avoid optimism. Base decisions on education, course choice, city, class, past behavior (none given). State clearly if purchasing power/motivation is low. Provide data-driven persuasion strategies.\n    *   **Input/Output Format:** Strict adherence to the specified YAML input and JSON output structure is required.\n    *   **Warning Clause:** If data is missing, inconsistent, or untrustworthy, set `payment_possibility` to "düşük" and `recommended_strategy` to "Daha fazla bilgi alınmalı". (The data seems consistent, just indicates a specific profile).\n    *   **Persona Examples:**\n        *   `Lise Öğrencisi` -> low payment possibility, suggest entry packages. This directly applies.\n        *   `3.-4. Sınıf Mühendislik Öğrencisi` -> high potential (Not applicable).\n        *   `Yurt dışında okuyanlar` -> 50-70% conversion (Not applicable).\n        *   `Mezun + Dijital Pazarlama Seçmiş` -> hot lead (Not applicable).\n    *   **Checklist:**\n        *   *Seçilen dersler*: Shows interest (Yazılım, Yapay Zeka, Satış/Pazarlama are valuable fields), but is it *realistic* interest for immediate *purchase* by a high school student? Likely aspirational or for exploration.\n        *   *Eğitim durumu*: Lise Öğrencisi -> directly impacts purchasing power (low).\n        *   *Şehir*: Ankara -> Major city, generally higher cost of living/opportunities, but less relevant for a student\'s *personal* buying power. Might indicate *parental* ability, but the model focuses on the *applicant*.\n        *   *Mail tipi*: Gmail -> Standard, no special insight.\n    *   **Note:** Be analytical, not judgmental. Every lead is an opportunity.\n\n4.  **Synthesize the Analysis based on Guidelines and Input:**\n\n    *   **`payment_possibility`:** The persona example explicitly states `Lise Öğrencisi` -> low payment possibility. This is the most direct guideline.\n        *   *Decision:* `"düşük"`\n\n    *   **`justification`:** Why low? Because the applicant is a high school student (Lise Öğrencisi). High school students typically lack independent income or significant purchasing power for potentially expensive courses like these. The interest exists, but the ability to pay is questionable *from the student directly*.\n        *   *Decision:* `"Aday lise öğrencisi olduğu için kişisel satın alma gücü ve ödeme yapma ihtimali düşüktür. Muhtemelen ebeveyn desteğine ihtiyaç duyacaktır."` (Candidate is a high school student, so personal purchasing power and payment probability are low. Will likely need parental support.) - This is concise, data-driven (education status), and objective.\n\n    *   **`buyer_persona`:** The input `Eğitim Durumu` is `Lise Öğrencisi`. The persona examples list this directly.\n        *   *Decision:* `"öğrenci"` (or maybe more specific like `"lise öğrencisi"`, but "öğrenci" is broader and fits the common segmentation). Let\'s stick to "öğrenci" as a general category for simplicity, though "lise öğrencisi" might be more precise. The example just says "öğrenci", so let\'s use that for consistency.\n\n    *   **`conversion_score`:** Low payment possibility translates to a low *direct* conversion score. While interested, the barrier is financial capability at this stage. Let\'s assign a low score, perhaps 10-20 range.\n        *   *Decision:* `15` (Arbitrary low number reflecting the low probability)\n\n    *   **`recommended_strategy`:** The persona example suggests "giriş paketleri önerilmeli". The goal is to keep the interest alive, potentially target the parents, or offer very low-cost/free introductory options. Nurturing for the future or involving parents seems key.\n        *   *Decision:* `"Adayın ilgisini canlı tutmak için ücretsiz kaynaklar veya çok düşük maliyetli giriş seviyesi eğitimler sunulabilir. Ebeveynleri hedefleyen iletişim veya geleceğe yönelik bilgilendirme yapılabilir."` (To keep the candidate\'s interest alive, free resources or very low-cost entry-level training can be offered. Communication targeting parents or future-oriented information can be provided.)\n\n    *   **`next_action`:** Direct sales push is unlikely to work. Nurturing is better. A low-touch, automated approach is suitable initially.\n        *   *Decision:* `"kampanya maili"` (A campaign email offering introductory content, free resources, or info on entry packages aligns with the strategy.) Alternatively, "ilgisiz bırak" might be considered if the target is only high-probability leads, but the Modelfile note says "Her aday, satış yolculuğunda bir fırsattır," suggesting nurturing is preferred over ignoring.\n\n5.  **Format the Output:** Assemble the decisions into the required JSON structure.\n\n    ```json\n    {\n      "payment_possibility": "düşük",\n      "justification": "Aday lise öğrencisi olduğu için kişisel satın alma gücü ve ödeme yapma ihtimali düşüktür. Muhtemelen ebeveyn desteğine ihtiyaç duyacaktır.",\n      "buyer_persona": "öğrenci",\n      "conversion_score": 15,\n      "recommended_strategy": "Adayın ilgisini canlı tutmak için ücretsiz kaynaklar veya çok düşük maliyetli giriş seviyesi eğitimler sunulabilir. Ebeveynleri hedefleyen iletişim veya geleceğe yönelik bilgilendirme yapılabilir.",\n      "next_action": "kampanya maili"\n    }\n    ```\n\n6.  **Final Review:** Does the output strictly follow the `Modelfile.md`?\n    *   JSON format correct? Yes.\n    *   All fields present? Yes.\n    *   `payment_possibility` options used correctly? Yes ("düşük").\n    *   `justification` data-driven? Yes (based on "Lise Öğrencisi").\n    *   `buyer_persona` reasonable? Yes ("öğrenci").\n    *   `conversion_score` range correct? Yes (0-100).\n    *   `recommended_strategy` actionable and relevant? Yes.\n    *   `next_action` logical? Yes.\n    *   Warning clause checked? Yes (data wasn\'t missing/inconsistent).\n    *   Persona examples considered? Yes (Lise Öğrencisi).\n    *   Checklist items considered? Yes.\n    *   Tone analytical, not judgmental? Yes.\n\nThe generated JSON appears consistent with all instructions.',
              },
              {
                text: '```json\n{\n  "payment_possibility": "düşük",\n  "justification": "Aday lise öğrencisi (Hazırlık sınıfı) olduğu için kişisel satın alma gücü ve ödeme yapma ihtimali düşüktür. Seçtiği dersler ilgi gösterse de, bu yaş grubunda genellikle finansal karar verici ebeveynlerdir.",\n  "buyer_persona": "öğrenci",\n  "conversion_score": 15,\n  "recommended_strategy": "Adayın ilgisini canlı tutmak için ücretsiz tanıtım materyalleri, webinarlar veya çok düşük maliyetli giriş seviyesi atölyeler sunulabilir. Ebeveynleri bilgilendirme odaklı bir iletişim veya gelecekteki potansiyelini göz önünde bulundurarak nurture (besleme) kampanyası düşünülebilir.",\n  "next_action": "kampanya maili"\n}\n```',
              },
            ],
          },
          {
            role: "user",
            parts: [
              {
                text: "Ad: Emine Nur Yıldız\nEğitim Durumu: Lisans Öğrencisi\nÜniversite: İstanbul Üniversitesi\nSınıf: 3. Sınıf\nSeçtiği Dersler: Yazılım Teknolojileri ve Yapay Zeka, Dijital Pazarlama, Satış ve Pazarlama\nŞehir: İstanbul\nMail: eminenuryildiz@ogr.istanbul.edu.tr\n\n",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: "The user wants me to analyze a potential buyer based on the provided application form data. I need to follow the defined `Modelfile.md` structure and principles.\n\n1.  **Analyze Input Data:**\n    *   `Ad`: Emine Nur Yıldız\n    *   `Eğitim Durumu`: Lisans Öğrencisi\n    *   `Üniversite`: İstanbul Üniversitesi (Reputable university in a major city)\n    *   `Sınıf`: 3. Sınıf (Closer to graduation, career focus likely increasing)\n    *   `Seçtiği Dersler`: Yazılım Teknolojileri ve Yapay Zeka, Dijital Pazarlama, Satış ve Pazarlama (Multiple related fields, showing high interest and potential career focus)\n    *   `Şehir`: İstanbul (Major city, potentially higher cost of living but also more opportunities/awareness)\n    *   `Mail`: eminenuryildiz@ogr.istanbul.edu.tr (University email, confirms student status and adds credibility)\n\n2.  **Evaluate according to Principles:**\n    *   **Payment Possibility:** University student (3rd year) in a major city, interested in high-demand skills (Software, AI, Digital Marketing, Sales). While still a student, being in the 3rd year often means increased focus on career and skill development, potentially leading to higher willingness to invest, possibly with family support or part-time work. The `.edu.tr` email adds seriousness. Multiple relevant course selections show strong intent. Compared to a high school student, the possibility is significantly higher. Let's rate it as \"orta\" leaning towards \"yüksek\", but \"orta\" is safer as direct income is unlikely.\n    *   **Justification:** The candidate is a 3rd-year university student at a major university (Istanbul University), indicating a nearing career stage. The selection of multiple high-demand courses (Software/AI, Digital Marketing, Sales) demonstrates strong motivation and relevance. University email (`.edu.tr`) adds credibility. While still a student, the combination of factors suggests a moderate likelihood of finding funds (self or family) for relevant skill development.\n    *   **Buyer Persona:** `Yüksek Potansiyelli Öğrenci` or `Kariyer Odaklı Öğrenci`. Based on the examples, `3.-4. Sınıf Mühendislik Öğrencisi` is high potential. This student isn't explicitly engineering but chose technical and business courses. Let's go with `yüksek potansiyelli öğrenci`.\n    *   **Conversion Score:** High interest (multiple courses), relevant stage (3rd year), major university/city. Let's estimate around 65-75. I'll choose 70.\n    *   **Recommended Strategy:** Focus on career benefits, potential job outcomes, and skill value. Offer student discounts or installment plans if possible. Highlight how these skills complement each other for future roles. Use case studies or testimonials from similar students.\n    *   **Next Action:** Given the high potential and specific interest, a targeted campaign mail focusing on career outcomes and possibly a special offer (student discount) would be appropriate. A direct call could also be considered later, but email first. Let's suggest `kampanya maili` with specific focus.\n\n3.  **Format Output as JSON:** Structure the analysis into the required JSON format.\n\n4.  **Review against Checklist:**\n    *   Seçilen dersler → Yes, shows high interest in marketable skills.\n    *   Eğitim durumu → Yes, 3rd-year university student suggests higher potential than younger students.\n    *   Şehir → Yes, Istanbul is a major hub.\n    *   Mail tipi → Yes, `.edu.tr` confirms student status and adds credibility.\n\n5.  **Final Check:** Ensure no judgmental language, focus on data. The assessment seems balanced.",
              },
              {
                text: '```json\n{\n  "payment_possibility": "orta",\n  "justification": "Aday, İstanbul Üniversitesi gibi büyük bir üniversitede 3. sınıf öğrencisi. Seçtiği dersler (Yazılım/AI, Dijital Pazarlama, Satış) kariyer odaklı ve yüksek motivasyon gösteriyor. Öğrenci olmasına rağmen, kariyerine yatırım yapma potansiyeli lise öğrencisine göre daha yüksektir. Üniversite maili kullanması ciddiyetini artırıyor.",\n  "buyer_persona": "yüksek potansiyelli öğrenci",\n  "conversion_score": 70,\n  "recommended_strategy": "Kariyer hedeflerine ve seçtiği derslerin iş hayatındaki değerine odaklanan bir iletişim kurulmalı. Öğrenci indirimleri, başarı hikayeleri veya staj/iş olanakları vurgulanabilir. Derslerin birbiriyle olan sinerjisi anlatılabilir.",\n  "next_action": "kampanya maili"\n}\n```',
              },
            ],
          },
          {
            role: "user",
            parts: [
              {
                text: "Ad: Berkay Acar\nEğitim Durumu: Lisans Öğrencisi\nÜniversite: Bartın Üniversitesi\nSınıf: 1. Sınıf\nSeçtiği Dersler: Yazılım Teknolojileri ve Yapay Zeka, Dijital Pazarlama, Satış ve Pazarlama\nŞehir: Bartın\nMail: berkayxx_123@hotmail.com",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: 'The user wants me to analyze a new applicant based on the provided `Modelfile.md`.\n\n**Applicant Data:**\n- Name: Berkay Acar\n- Education: Undergraduate Student\n- University: Bartın Üniversitesi\n- Class: 1st Year\n- Courses: Yazılım Teknolojileri ve Yapay Zeka, Dijital Pazarlama, Satış ve Pazarlama\n- City: Bartın\n- Mail: berkayxx_123@hotmail.com\n\n**Analysis based on `Modelfile.md` principles:**\n\n1.  **Role:** Act as a financial assessment and digital sales AI consultant.\n2.  **Principles:**\n    *   **Data-driven:** Analyze provided info.\n    *   **Objective:** Avoid bias.\n    *   **Missing Info:** Note if applicable (not much missing here).\n    *   **Context:** Avoid overly optimistic views.\n    *   **Key Factors:** Education (1st year undergrad), Course choice (multiple, diverse), City (Bartın - might indicate lower purchasing power compared to major cities, but not a definitive factor alone), Class (1st year - less immediate career pressure than 3rd/4th year), Email (Hotmail - less formal/institutional than edu.tr or corporate).\n    *   **Low Power/Motivation:** State clearly if applicable. 1st year might have lower immediate motivation/power than later years.\n    *   **Persuasion Strategies:** Generate based on data.\n3.  **Input Format:** Received correctly.\n4.  **Output Format:** Must be the specified JSON.\n5.  **Warning:** Check for inconsistencies (none obvious). Email type is less formal.\n6.  **Personas:**\n    *   `Lise Öğrencisi`: low potential (N/A)\n    *   `3.-4. Sınıf Mühendislik`: high potential (N/A)\n    *   `Yurt dışında okuyanlar`: 50-70% conversion (N/A)\n    *   `Mezun + Dijital Pazarlama Seçmiş`: hot lead (N/A)\n    *   General idea: 1st year undergrad is better than high school, but less potential than 3rd/4th year or graduate. Multiple course selections show interest. Bartın might imply slightly lower purchasing power than Istanbul/Ankara. Hotmail is less professional.\n7.  **Checklist:**\n    *   Courses: Show interest across multiple relevant fields (Software/AI, Digital Marketing, Sales). High interest signal.\n    *   Education: 1st-year undergrad. Lower immediate payment power/urgency compared to later years or professionals.\n    *   City: Bartın. Potentially lower purchasing power, but not a strong negative signal alone.\n    *   Mail: Hotmail. Less formal, could indicate less seriousness, but not a deal-breaker.\n8.  **Note:** Be analytical, not judgmental.\n\n**Drafting the JSON:**\n\n*   `payment_possibility`: "Orta" seems appropriate. Better than high school, shows interest via multiple courses, but still early in studies and in a smaller city. Not "düşük" because they are in university and selected multiple courses. Not "yüksek" due to being 1st year and using Hotmail. Let\'s refine: maybe "orta-düşük"? The modelfile asks for "düşük / orta / yüksek". Given the factors (1st year, Hotmail, Bartın vs multiple course interest), leaning towards "orta" but on the lower end of orta, or perhaps "düşük" is safer given the instructions to be cautious. Let\'s compare with the previous "orta" case (3rd year, Istanbul Uni, edu.tr mail). This case is significantly weaker. Let\'s go with "düşük".\n*   `justification`: Aday 1. sınıf lisans öğrencisi ve Bartın\'da yaşıyor. Erken aşamada olması ve daha az kurumsal bir mail adresi (hotmail) kullanması, ödeme potansiyelini düşürüyor. Ancak birden fazla ders seçmesi (Yazılım/AI, Dijital Pazarlama, Satış) ilgi gösterdiğini belirtir.\n*   `buyer_persona`: "Erken kariyer adayı" or "ilgili öğrenci". Given they are 1st year, "ilgili öğrenci" or just "öğrenci" fits better than "erken kariyer". Let\'s use "öğrenci".\n*   `conversion_score`: Compared to the previous 70 (3rd year, Istanbul, edu.tr), this should be lower. Maybe 30-40? Multiple courses are a plus, but 1st year and Hotmail are negatives. Let\'s set it to 35.\n*   `recommended_strategy`: Nurturing approach. Focus on the long-term benefits and building foundational skills. Offer introductory content, maybe bundle discounts if they commit early. Highlight how these diverse skills complement each other.\n*   `next_action`: "Kampanya maili" or "ilgisiz bırak"? Given the interest shown by selecting multiple courses, "kampanya maili" focused on nurturing seems appropriate rather than ignoring.\n\n**Refining the Justification and Strategy:**\n\n*   Justification: "Aday 1. sınıf öğrencisi ve Bartın Üniversitesi\'nde okuyor. Henüz eğitiminin başında olması ve kişisel mail (hotmail) kullanması nedeniyle ödeme gücü ve aciliyeti düşük olabilir. Ancak Yazılım/AI, Dijital Pazarlama ve Satış gibi birden fazla popüler alana ilgi göstermesi potansiyel taşıdığını belirtir."\n*   Strategy: "Adayın ilgisini canlı tutmak ve uzun vadeli bir ilişki kurmak için bilgilendirici içerikler (webinar, blog yazıları) ve giriş seviyesi paketler/öğrenci indirimleri sunulabilir. Farklı alanlara olan ilgisi birleştirilerek kariyer yolculuğunda bu yetkinliklerin nasıl fayda sağlayacağı anlatılabilir."\n*   Next Action: "Kampanya maili" (nurturing focus).\n\nOkay, the plan looks solid. I will generate the JSON output based on this analysis.',
              },
              {
                text: '```json\n{\n  "payment_possibility": "düşük",\n  "justification": "Aday 1. sınıf öğrencisi ve Bartın Üniversitesi\'nde okuyor. Henüz eğitiminin başında olması ve kişisel mail adresi (hotmail) kullanması nedeniyle anlık ödeme gücü ve aciliyeti düşük olabilir. Ancak Yazılım/AI, Dijital Pazarlama ve Satış gibi birden fazla popüler alana ilgi göstermesi potansiyel taşıdığını belirtir.",\n  "buyer_persona": "öğrenci",\n  "conversion_score": 35,\n  "recommended_strategy": "Adayın ilgisini canlı tutmak ve uzun vadeli bir ilişki kurmak amacıyla bilgilendirici içerikler (webinar, blog yazıları) ve giriş seviyesi paketler/öğrenci indirimleri sunulabilir. Farklı alanlara olan ilgisi birleştirilerek kariyer yolculuğunda bu yetkinliklerin nasıl fayda sağlayacağı vurgulanabilir.",\n  "next_action": "kampanya maili"\n}\n```',
              },
            ],
          },
          {
            role: "user",
            parts: [
              {
                text: "Ad: Hatice Aylin Gülenç\nEğitim Durumu: Lisans Mezunu\nÜniversite: Kocaeli Üniversitesi\nSınıf: Mezun\nSeçtiği Dersler: Yazılım Teknolojileri ve Yapay Zeka\nMail: aylinngulenc@gmail.com",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: 'The user wants an analysis of a potential buyer based on the provided information.\n\n**Input Data:**\n- Name: Hatice Aylin Gülenç\n- Education: Lisans Mezunu (University Graduate)\n- University: Kocaeli Üniversitesi\n- Class: Mezun (Graduate)\n- Selected Courses: Yazılım Teknolojileri ve Yapay Zeka (Software Technologies and AI)\n- City: Not provided (Missing data point)\n- Mail: aylinngulenc@gmail.com\n\n**Analysis Steps:**\n1.  **Payment Possibility:**\n    *   The candidate is a university graduate. Graduates generally have higher earning potential or are actively seeking jobs, making them more likely to invest in skills compared to students.\n    *   Interest in "Yazılım Teknolojileri ve Yapay Zeka" is a high-demand field, suggesting career focus.\n    *   Graduates often have a higher immediate need/motivation for upskilling for job hunting or career change.\n    *   *Initial thought:* High.\n    *   *Refinement:* While graduates have potential, "Mezun" doesn\'t specify *when* they graduated or if they are employed. Lack of city information is a minor missing point but doesn\'t critically impact payment potential assessment based on education status. Gmail address is neutral. The specific field (Software/AI) indicates a willingness to invest in valuable skills. Let\'s rate it as "yüksek" (high) due to the graduate status and high-value course selection.\n\n2.  **Justification:**\n    *   Clearly state the reasoning based on the data points: Graduate status, interest in a high-demand field (Software/AI), indicating career focus and potential willingness to invest in skills for employment or career advancement.\n\n3.  **Buyer Persona:**\n    *   The candidate is a graduate looking into a technical field. They could be seeking their first job, looking to specialize, or even change careers.\n    *   *Options:* Erken kariyer (Early Career), Profesyonel (if employed, but we don\'t know), Yüksek Potansiyelli (High Potential).\n    *   "Erken kariyer" or "Yüksek Potansiyelli Mezun" seems appropriate given the graduate status and course choice. Let\'s use "erken kariyer / kariyer geliştirme".\n\n4.  **Conversion Score:**\n    *   Graduates interested in high-demand tech fields are generally strong leads.\n    *   Compared to a 3rd-year student (score 70), a graduate likely has a slightly higher urgency or capacity.\n    *   *Score:* Let\'s set it around 75-85. Given the focus on a single, high-value course area, let\'s go with 80.\n\n5.  **Recommended Strategy:**\n    *   Focus on career outcomes: How this course leads to job opportunities, salary increases, or specialization.\n    *   Highlight practical applications and project-based learning.\n    *   Mention industry demand for AI/Software skills.\n    *   Offer flexible payment options if available, acknowledging potential budget constraints for recent graduates.\n    *   Success stories of previous graduates.\n\n6.  **Next Action:**\n    *   Since the potential is high, a more direct approach than just a generic campaign mail might be warranted.\n    *   *Options:* Özel indirim (Special discount), detailed course information mail, perhaps even scheduling a call if resources allow.\n    *   Let\'s suggest "özel indirim" or "detaylı bilgi maili". "Özel indirim" aligns well with encouraging conversion for a high-potential lead.\n\n7.  **Final JSON Structure Check:** Ensure all fields match the required format.\n\n**(Self-Correction/Refinement):**\n*   Is "yüksek" too strong for `payment_possibility` without knowing employment status? "Orta" might be safer, but "Lisans Mezunu" + "Yazılım/AI" strongly implies intent to invest for career reasons. Sticking with "yüksek" but acknowledging this in the justification implicitly.\n*   "Erken kariyer / kariyer geliştirme" is a good persona description.\n*   Score 80 seems reasonable.\n*   Strategy focusing on career outcomes is key.\n*   "Özel indirim" as the next action is a strong call to action for this persona.\n\nOkay, constructing the final JSON.',
              },
              {
                text: '```json\n{\n  "payment_possibility": "yüksek",\n  "justification": "Aday lisans mezunu ve kariyer odaklı, yüksek talep gören \'Yazılım Teknolojileri ve Yapay Zeka\' alanını seçmiş. Mezuniyet durumu, genellikle iş arama veya kariyer geliştirme amacıyla eğitime yatırım yapma olasılığını artırır.",\n  "buyer_persona": "erken kariyer / kariyer geliştirme",\n  "conversion_score": 80,\n  "recommended_strategy": "Bu alandaki kariyer fırsatları, sektördeki talep ve eğitimin pratik kazanımları (portfolyo projeleri vb.) vurgulanmalı. Mezunlara yönelik başarı hikayeleri ve olası erken kayıt indirimleri sunulabilir.",\n  "next_action": "özel indirim"\n}\n```',
              },
            ],
          },
          {
            role: "user",
            parts: [
              {
                text: "Ad: Sude Beyza Türkoğlu\nEğitim Durumu: Lisans Öğrencisi\nÜniversite: İstinye Üniversitesi\nBolum: İngiliz Dili ve Edebiyatı\nSınıf: 3.Sınıf\nSeçtiği Dersler: Satış, Pazarlama ve Marka Yaratma, Dijital Pazarlama, Influencer Marketing ve Girişimcilik, İnsan Kaynakları ve Yetenek Kazanımı\nMail: beyzasude55@gmail.com",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: 'The user wants me to analyze a potential buyer based on the provided information using the predefined `Modelfile.md` structure and logic.\n\n**Input Data:**\n- Ad: Sude Beyza Türkoğlu\n- Eğitim Durumu: Lisans Öğrencisi\n- Üniversite: İstinye Üniversitesi\n- Bolum: İngiliz Dili ve Edebiyatı (This is new information, not in the standard template, but relevant)\n- Sınıf: 3.Sınıf\n- Seçtiği Dersler: Satış, Pazarlama ve Marka Yaratma, Dijital Pazarlama, Influencer Marketing ve Girişimcilik, İnsan Kaynakları ve Yetenek Kazanımı\n- Şehir: Not provided (Defaulting to neutral impact unless specified)\n- Mail: beyzasude55@gmail.com\n\n**Analysis based on `Modelfile.md` principles:**\n\n1.  **Role:** Act as an AI consultant specialized in financial assessment and digital sales.\n2.  **Principles:**\n    *   **Data-driven:** Analyze the provided data objectively.\n    *   **Identify missing info:** City is missing, but not critical for this profile.\n    *   **Avoid optimism:** Be realistic.\n    *   **Consider key factors:**\n        *   Eğitim Durumu: Lisans Öğrencisi, 3. Sınıf -> Potential for investment, but still a student.\n        *   Üniversite: İstinye Üniversitesi (Private university) -> May indicate higher willingness/ability to pay compared to some state universities, but not a guarantee.\n        *   Bölüm: İngiliz Dili ve Edebiyatı -> Traditionally not directly linked to the chosen courses (Sales, Marketing, HR, Entrepreneurship). This suggests a potential career shift or complementary skill development interest. This is a very strong signal of motivation *outside* her main field.\n        *   Seçtiği Dersler: A *wide* range of business-related skills (Sales, Marketing, Branding, Digital Marketing, Influencer Marketing, Entrepreneurship, HR). This shows strong interest but might also indicate uncertainty about the exact path. The *number* of courses selected is high.\n        *   Sınıf: 3. Sınıf -> Close to graduation, likely thinking about career prospects.\n        *   Şehir: Missing - assume neutral.\n        *   Mail: Gmail (Personal) -> Neutral.\n    *   **Indicate lack of power/motivation if applicable:** Motivation seems high due to the number and type of courses selected, especially given her major. Buying power is moderate as she\'s a 3rd-year student.\n    *   **Generate persuasion strategies:** Based on the profile.\n3.  **Input Format:** Received YAML-like structure.\n4.  **Output Format:** Must be the specified JSON structure.\n5.  **Warnings:** Data seems consistent and sufficient. No need for the warning output.\n6.  **Personas:** She\'s a student, but her course selection and year suggest a strong drive towards business/marketing/HR roles, potentially diverging from her major. "Yüksek potansiyelli öğrenci" or "Kariyer odaklı öğrenci" fits.\n7.  **Checklist:**\n    *   Seçilen dersler → High interest in business/marketing/HR, potential career shift.\n    *   Eğitim durumu → 3rd year student, moderate payment power, high motivation likely.\n    *   Şehir → Missing, neutral.\n    *   Mail tipi → Gmail, neutral.\n8.  **Note:** Be analytical, not judgmental.\n\n**Synthesizing the JSON Output:**\n\n*   `payment_possibility`: "orta". She\'s a 3rd-year student, potentially motivated to invest in skills outside her major before graduating. Private university might suggest some capacity, but she\'s still a student. The high number of diverse courses might mean she\'s exploring, or serious about a multi-skilled profile.\n*   `justification`: "3. sınıf öğrencisi, kariyerine yakın. İngiliz Dili ve Edebiyatı bölümünden olmasına rağmen Satış, Pazarlama, İK gibi çok sayıda iş odaklı ders seçmesi, kariyer değişikliği veya ek yetkinlik kazanma motivasyonunun yüksek olduğunu gösteriyor. Öğrenci olması ödeme gücünü orta seviyede tutuyor."\n*   `buyer_persona`: "kariyer odaklı öğrenci" (or "yüksek potansiyelli öğrenci"). Captures the drive despite being a student.\n*   `conversion_score`: Let\'s rate it moderately high due to the strong signal from course selection despite the non-business major. Maybe 65-75. Let\'s go with 70.\n*   `recommended_strategy`: Focus on how these diverse skills complement each other and enhance career prospects *regardless* of her major. Highlight testimonials from non-business backgrounds who succeeded after taking these courses. Bundle offers for multiple courses could be attractive. Emphasize practical application and career transition/enhancement.\n*   `next_action`: "kampanya maili" or perhaps a more personalized approach given the interesting profile, maybe "özel indirim" on a bundle. Let\'s stick to "kampanya maili" as a standard first step, but tailored content.',
              },
              {
                text: '```json\n{\n  "payment_possibility": "orta",\n  "justification": "Aday 3. sınıf öğrencisi, mezuniyete ve kariyer başlangıcına yaklaşıyor. İngiliz Dili ve Edebiyatı bölümünden olmasına rağmen Satış, Pazarlama, Dijital Pazarlama, Influencer Marketing, Girişimcilik ve İK gibi çok çeşitli ve iş odaklı dersler seçmesi, kariyerini bu alanlarda şekillendirme veya mevcut bölümünü bu yetkinliklerle destekleme konusunda yüksek motivasyon gösteriyor. Öğrenci olması nedeniyle ödeme gücü \'orta\' olarak değerlendirilmiştir, ancak motivasyonu yüksektir.",\n  "buyer_persona": "kariyer odaklı öğrenci",\n  "conversion_score": 70,\n  "recommended_strategy": "Seçtiği derslerin birbiriyle nasıl ilişkili olduğunu ve kariyer hedeflerine (özellikle bölümü dışındaki alanlara yöneliyorsa) nasıl katkı sağlayacağını vurgulayın. İngiliz Dili ve Edebiyatı mezunlarının bu alanlarda nasıl başarılı olabileceğine dair örnekler veya başarı hikayeleri sunulabilir. Çoklu ders seçimi nedeniyle paket indirimleri veya esnek ödeme seçenekleri cazip olabilir.",\n  "next_action": "kampanya maili"\n}\n```',
              },
              {
                text: 'My thinking process to update the Modelfile based on the new city-based interest data goes like this:\n\n1.  **Understand the Goal:** The user wants to incorporate city-specific data about course popularity into the analysis of potential buyers. The model should use this new data layer to refine its assessment of `payment_possibility`, `justification`, `conversion_score`, and potentially `recommended_strategy` and `next_action`.\n\n2.  **Identify the Core Change:** The primary change is the addition of a new input dimension: *city-based course interest*. This needs to be integrated into the existing logic which considers education level, class, chosen courses, and email type.\n\n3.  **Analyze the City Data:**\n    *   The data is a JSON array of objects, each representing a city.\n    *   Each city object has: `sehir` (city name), `toplam_basvuru_sayisi` (total applications from that city), and counts for specific course categories (`insan_kaynaklari_yetenek`, `dijital_pazarlama_girisimcilik`, `satis_pazarlama_marka`, `yazilim_yapay_zeka`).\n    *   Some cities have very high application numbers (Istanbul, Aydın, Aksaray, Ankara, Adıyaman, İzmir), while others have very low numbers (Tunceli, Muş, Sinop, etc.).\n    *   Within a city, the interest in different course categories varies significantly. For example, in Istanbul, Yazılım/AI and Dijital Pazarlama are very popular, while Satış/Pazarlama/Marka has 0 recorded interest (this might be a data issue or a specific course grouping). In Aydın, Dijital Pazarlama and Yazılım/AI dominate. In Aksaray and Amasya, the specific course interests seem disproportionately low compared to the total applications (possible data quality issue or most applications didn\'t specify these courses). Adıyaman shows high interest across the board relative to its total.\n    *   **Key Insight:** If a candidate from a city with *high* overall application volume chooses a course *popular* in that city, their interest is likely genuine and reflects a local trend/demand, potentially increasing conversion likelihood. Conversely, if a candidate from a low-volume city chooses a popular course, it might indicate strong individual motivation, but the overall market size/potential in that city is smaller. If a candidate chooses a course that is *unpopular* in their high-volume city, it might signal niche interest or less alignment with local trends.\n\n4.  **Map Input Courses to City Data Categories:** The input format uses course names like "Yazılım Teknolojileri ve Yapay Zeka", "Satış ve Pazarlama", "Dijital Pazarlama", "Influencer Marketing ve Girişimcilik", "İnsan Kaynakları ve Yetenek Kazanımı". These need to be mapped to the categories in the city data:\n    *   "Yazılım Teknolojileri ve Yapay Zeka" -> `yazilim_yapay_zeka`\n    *   "Satış ve Pazarlama" / "Satış, Pazarlama ve Marka Yaratma" -> `satis_pazarlama_marka` (Note: This category has 0 interest in all cities in the provided data, which is strange and might require clarification or careful handling).\n    *   "Dijital Pazarlama" / "Influencer Marketing ve Girişimcilik" -> `dijital_pazarlama_girisimcilik`\n    *   "İnsan Kaynakları ve Yetenek Kazanımı" -> `insan_kaynaklari_yetenek`\n\n5.  **Update the `Modelfile.md`:**\n\n    *   **Role & Principles:** Reiterate the inclusion of city data. Add a principle like: "Incorporate city-level course interest data to contextualize the applicant\'s choices."\n    *   **Input:** No change needed here, the input format remains the same.\n    *   **Output:** No change needed in the structure, but the *logic* for deriving the values will change.\n    *   **Evaluation Principles:** Explicitly mention using the city data. "Kullanıcının eğitim durumu, ders tercihi, **şehir (ve o şehirdeki eğitim ilgisi)**, sınıf ve geçmiş ödeme davranışlarına göre karar ver."\n    *   **Warning:** No change needed.\n    *   **Personas/Segments:** Keep existing examples, but potentially add notes about how city data might modify these (e.g., "Lise Öğrencisi (İstanbul, popüler ders seçti)" might have slightly higher *interest* score, though still low payment possibility).\n    *   **Control List:** Add a point: "- Şehirdeki eğitim ilgisi → adayın motivasyonunu ve yerel talebi yansıtıyor mu?"\n    *   **New Section (Crucial):** Add a dedicated section explaining *how* the city data will be used. This acts as instructions for the model\'s internal reasoning.\n\n6.  **Drafting the New Section/Logic:** How should the city data influence the analysis?\n    *   **High Application City + Popular Course Choice:** Increases confidence in the applicant\'s interest alignment with local trends. Might slightly boost `conversion_score` and reinforce `payment_possibility` if other factors (like education level) are positive. Justification should mention this alignment.\n    *   **High Application City + Unpopular Course Choice:** Might indicate niche interest or potentially lower alignment. Doesn\'t necessarily decrease `payment_possibility` but might warrant checking if the applicant understands the local market (less relevant for purely online courses, perhaps). Justification could note the deviation from the city trend.\n    *   **Low Application City + Popular Course Choice (relative to that city\'s low numbers):** Suggests strong individual motivation. `conversion_score` might be slightly boosted due to this individual drive, but overall market potential in that city might be lower (relevant if local networking/jobs are part of the value proposition).\n    *   **Low Application City + Unpopular Course Choice:** Very niche interest. Conversion might depend heavily on individual factors. `conversion_score` likely lower unless other indicators are very strong.\n    *   **Handling the Zero-Interest Category (`satis_pazarlama_marka`):** If a candidate chooses this, and the data consistently shows 0 interest, the model should note this discrepancy. It might be a data error, or the course is genuinely not popular *under that specific name/grouping* in the data provided. The analysis should rely more heavily on other factors in this case.\n    *   **Averaging/Weighting:** The model shouldn\'t just look at *one* chosen course if multiple are selected. It should consider the *pattern* of choices against the city data.\n\n7.  **Refining the `Modelfile.md` Text:** Translate the logic above into clear instructions within the Modelfile. Add a new section like "Şehir Verisinin Kullanımı" (Use of City Data) or integrate it into "Değerlendirme Prensipleri". Ensure the language is directive ("kullan", "değerlendir", "etkiler"). Make sure the mapping between input course names and city data categories is implicitly understood or explicitly stated if necessary. Update the overall role description to reflect this new capability.\n\n8.  **Final Review:** Read through the entire updated `Modelfile.md`. Does it clearly explain the model\'s role, inputs, outputs, and reasoning process, *including* the new city data integration? Is it consistent? Is the JSON output format still correct? Yes.',
              },
              {
                text: 'The user wants me to analyze a potential buyer based on the provided information, using the updated `Modelfile.md` which now includes city-based interest data.\n\n**Input Data:**\n*   **Ad:** Ceren Yılmaz\n*   **Şehir:** Ankara\n*   **Eğitimler:** Dijital Pazarlama, Satış (Needs mapping to categories)\n*   **Eğitim Durumu:** Lisans - 3. Sınıf\n*   **Mail:** cerenylmz@gmail.com\n*   **Üniversite:** Not provided\n*   **Bolum:** Not provided\n\n**Analysis Steps:**\n\n1.  **Map Seçilen Dersler to Categories:**\n    *   "Dijital Pazarlama" -> `dijital_pazarlama_girisimcilik`\n    *   "Satış" -> `satis_pazarlama_marka` (Assuming this mapping, although the city data shows 0 for this category everywhere. I should note this lack of data).\n2.  **Check City Data for Ankara:**\n    *   **Ankara Data:** `{"sehir":"ANKARA","toplam_basvuru_sayisi":"599","insan_kaynaklari_yetenek":"320","dijital_pazarlama_girisimcilik":"340","satis_pazarlama_marka":"0","yazilim_yapay_zeka":"424"}`\n    *   **Dijital Pazarlama in Ankara:** 340 applications out of 599 total. This is a significant portion (around 57%), indicating high interest in Ankara.\n    *   **Satış in Ankara:** 0 applications recorded in the provided data for the `satis_pazarlama_marka` category. This specific category seems to have no data across all cities in the provided JSON. I will have to rely on the Dijital Pazarlama interest and the general profile.\n3.  **Evaluate Profile:**\n    *   **Eğitim Durumu:** Lisans - 3. Sınıf. Approaching graduation, likely career-focused. Moderate potential purchasing power as a student, but higher motivation than early-year students.\n    *   **Şehir:** Ankara. A major city with significant interest in Digital Marketing based on the data.\n    *   **Seçilen Dersler:** Dijital Pazarlama (high interest in Ankara) and Satış (data lacking, but generally related to business/marketing). Shows clear career direction.\n    *   **Mail:** Gmail. Standard personal email.\n4.  **Determine Payment Possibility:** "Orta". Student status limits immediate high purchasing power, but 3rd year status, relevant course selection, and high regional interest in one of the courses suggest reasonable potential.\n5.  **Formulate Justification:** Mention 3rd-year student status, career-oriented course selection (Digital Marketing, Sales), and specifically note the high popularity of Digital Marketing in Ankara according to the provided data. Acknowledge the lack of data for the "Satış" category in the city data.\n6.  **Assign Buyer Persona:** "Kariyer odaklı öğrenci" or "Bölgesel trend takipçisi öğrenci" due to selecting a popular course in her city. "Kariyer odaklı öğrenci" seems more encompassing.\n7.  **Calculate Conversion Score:** Relatively high due to being a 3rd-year student, choosing relevant courses, and the high interest in Digital Marketing in Ankara. Maybe around 65-75. Let\'s go with 70.\n8.  **Recommend Strategy:** Focus on career benefits, leveraging the popularity of Digital Marketing in Ankara. Mention student discounts, perhaps link Digital Marketing and Sales skills. Highlight potential career paths in Ankara for these skills.\n9.  **Define Next Action:** "Kampanya maili" focused on career outcomes and student offers, possibly mentioning the regional demand.\n\n**Refinement:**\n*   The "Satış" course maps to `satis_pazarlama_marka` which has 0 interest in Ankara (and all other cities in the provided data). I must explicitly mention this lack of specific data point for Sales interest but infer relevance from the Digital Marketing choice.\n*   The persona could be refined slightly to reflect the city data influence.\n\nLet\'s construct the JSON output.',
              },
            ],
          },
          {
            role: "user",
            parts: [
              {
                text: "Ad: Halil Murat Yıldız  \nEğitim Durumu: Lisans Öğrencisi  \nÜniversite: Trakya Üniversitesi  \nBölüm: İşletme  \nSınıf: 2. Sınıf  \nSeçtiği Dersler: Satış, Pazarlama ve Marka Yaratma  \nŞehir: Edirne  \nMail: halilmurat97@gmail.com\n",
              },
            ],
          },
          {
            role: "model",
            parts: [
              {
                text: 'The user wants me to analyze a potential lead based on the provided `Modelfile.md` instructions.\n\nInput Data:\n- Ad: Halil Murat Yıldız\n- Eğitim Durumu: Lisans Öğrencisi\n- Üniversite: Trakya Üniversitesi\n- Bölüm: İşletme\n- Sınıf: 2. Sınıf\n- Seçtiği Dersler: Satış, Pazarlama ve Marka Yaratma\n- Şehir: Edirne\n- Mail: halilmurat97@gmail.com\n\nAnalysis based on `Modelfile.md`:\n1.  **Role**: Act as an AI consultant specialized in financial assessment and digital sales.\n2.  **Task**: Analyze payment probability, purchasing power (based on profile), and persuasion strategies.\n3.  **Principles**: Data-driven, objective, mention missing info (not applicable here), avoid over-optimism, consider education, course choice, city, class, past behavior (not available), clearly state low potential, produce data-based strategies.\n4.  **Input Format**: Checked, YAML-like structure.\n5.  **Output Format**: Strict JSON structure required.\n6.  **Warning**: N/A - Data seems consistent and complete enough for a basic assessment.\n7.  **Personas**:\n    - Lise Öğrencisi -> low (not applicable)\n    - 3rd-4th Eng. Student -> high potential (not applicable)\n    - Abroad -> 50-70% (not applicable)\n    - Graduate + Digital Marketing -> hot lead (not applicable)\n    - General Student: Implied lower than graduate/professional.\n8.  **Checklist**:\n    - Seçilen dersler (Satış, Pazarlama ve Marka Yaratma): Directly relevant to his Business major. Shows clear interest and career alignment. Strong indicator.\n    - Eğitim durumu (Lisans Öğrencisi, 2. Sınıf, İşletme): Typical student profile. 2nd year means still early in studies, potentially lower immediate purchasing power than a final-year student, but directly relevant field increases potential interest. Business students often seek practical skills.\n    - Şehir (Edirne): Not a major metropolitan hub like Istanbul/Ankara, which *might* slightly correlate with lower average purchasing power or fewer local job opportunities to fund such courses, but this is a weak signal and shouldn\'t be overemphasized. Trakya University is a state university.\n    - Mail tipi (gmail.com): Standard personal email. Doesn\'t add or detract significantly.\n\nAssessment Synthesis:\n-   **Payment Possibility**: He\'s a 2nd-year student, so immediate personal funds might be limited. However, he\'s studying Business and chose a directly relevant course (Sales, Marketing, Branding). This indicates strong alignment and potential motivation to invest in skills relevant to his future career. Compared to a 1st-year student or someone choosing unrelated courses, his potential is higher. Compared to a final-year student or graduate, it\'s lower. "Orta" (Medium) seems appropriate.\n-   **Justification**: Student status (2nd year) limits immediate funds, but the chosen course directly aligns with his Business major, indicating strong relevance and potential career motivation.\n-   **Buyer Persona**: "kariyer odaklı öğrenci" (career-oriented student) or simply "öğrenci" fits. Given the direct course relevance, "kariyer odaklı öğrenci" is slightly better.\n-   **Conversion Score**: Higher than a 1st-year student, lower than a final-year or graduate. Maybe around 55-65? Let\'s go with 60.\n-   **Recommended Strategy**: Highlight how the course provides practical skills complementing his Business degree, improving internship/job prospects. Emphasize practical application, case studies, and potential career benefits. Student discounts are relevant.\n-   **Next Action**: Start with a targeted campaign email focusing on the benefits for Business students.\n\nRefining the JSON:\n-   `payment_possibility`: "orta"\n-   `justification`: "Aday, İşletme bölümü 2. sınıf öğrencisi. Seçtiği \'Satış, Pazarlama ve Marka Yaratma\' dersi, bölümüyle doğrudan ilişkili olup kariyer hedeflerine yönelik güçlü bir ilgi ve motivasyon göstermektedir. Öğrenci olması ödeme gücünü sınırlasa da, dersin uygunluğu potansiyeli artırıyor." (Candidate is a 2nd-year Business student. The chosen \'Sales, Marketing and Branding\' course is directly related to his major, showing strong interest and motivation towards career goals. While being a student limits purchasing power, the course relevance increases potential.)\n-   `buyer_persona`: "kariyer odaklı öğrenci"\n-   `conversion_score`: 60\n-   `recommended_strategy`: "İşletme eğitimiyle bu dersin nasıl entegre olabileceğini, staj ve iş hayatında sağlayacağı pratik faydaları vurgulayın. Vaka çalışmaları, sektörden örnekler ve öğrenci indirimleri sunulabilir." (Highlight how this course can integrate with a Business education and the practical benefits it will provide in internships and professional life. Case studies, industry examples, and student discounts can be offered.)\n-   `next_action`: "kampanya maili"\n\nDouble-check against instructions: JSON format is correct, fields are filled, justification is data-based, strategy is actionable, persona is assigned, score is given. Follows principles.',
              },
              {
                text: '```json\n{\n  "payment_possibility": "orta",\n  "justification": "Aday, İşletme bölümü 2. sınıf öğrencisi. Seçtiği \'Satış, Pazarlama ve Marka Yaratma\' dersi, bölümüyle doğrudan ilişkili olup kariyer hedeflerine yönelik güçlü bir ilgi ve motivasyon göstermektedir. Öğrenci olması ödeme gücünü sınırlasa da, dersin uygunluğu potansiyeli artırıyor.",\n  "buyer_persona": "kariyer odaklı öğrenci",\n  "conversion_score": 60,\n  "recommended_strategy": "İşletme eğitimiyle bu dersin nasıl entegre olabileceğini, staj ve iş hayatında sağlayacağı pratik faydaları vurgulayın. Vaka çalışmaları, sektörden örnekler ve öğrenci indirimleri sunulabilir.",\n  "next_action": "kampanya maili"\n}\n```',
              },
            ],
          },
        ],
      });

      const result = await chat.sendMessage(userMessage);
      const text = result.response
        .text()
        .match(/```json\n([\s\S]*?)\n```/);
      setResponse(text ? text[1] : null);
    } catch (err: any) {
      console.error("Gemini chat error:", err);
      setError("Bir hata oluştu.");
    } finally {
      setLoading(false);
    }
  };

  return {
    sendMessage,
    response,
    loading,
    error,
  };
}
